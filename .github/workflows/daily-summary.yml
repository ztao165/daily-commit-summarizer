name: Daily LLM Commit Summary

on:
  schedule:
    - cron: "0 10 * * *"   # 10:00 UTC = 18:00 北京时间
  workflow_dispatch: {}     # 手动触发

jobs:
  run:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - repo: Global-MongoX/backend-api
            path: target-backendx-api
          - repo: Global-MongoX/backend-crm
            path: target-backendx-crm
          - repo: Global-MongoX/backend-config
            path: target-backendx-config
          - repo: Global-MongoX/backend-scaffold
            path: target-backendx-scaffold
          - repo: Global-MongoX/backend-flux
            path: target-backendx-flux
          - repo: Global-MongoX/backend-contract
            path: target-backendx-contract
    env:
      TZ: Asia/Shanghai
    steps:
      - name: Checkout summarizer
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout target repository (${{ matrix.repo }})
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: ${{ matrix.repo }}
          token: ${{ secrets.REPO_CLONE_TOKEN }}
          path: ${{ matrix.path }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Run summarizer
        working-directory: ${{ matrix.path }}
        env:
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          LARK_WEBHOOK_URL: ${{ secrets.LARK_WEBHOOK_URL }}
          REPO: ${{ matrix.repo }}
        run: |
          npx --yes tsx ../scripts/daily-summary.ts
